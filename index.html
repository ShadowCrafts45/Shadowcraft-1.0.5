<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dough3D - 3D Modeling App</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1f2937;
            color: #f3f4f6;
            margin: 0;
            overflow: hidden;
        }
        canvas {
            display: block;
            touch-action: none;
        }
        .panel-header {
            padding: 8px 12px;
            font-size: 0.875rem;
            font-weight: 600;
            background-color: #374151;
            border-bottom: 1px solid #4b5563;
        }
        .panel-content {
            overflow-y: auto;
            flex-grow: 1;
            padding: 8px 0;
        }
        .menu-dropdown {
            position: absolute;
            top: 40px;
            left: 0;
            z-index: 20;
            background-color: #374151;
            border-radius: 6px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.5);
            min-width: 150px;
            padding: 4px 0;
        }
        .menu-item {
            padding: 8px 16px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: background-color 0.15s;
        }
        .menu-item:hover {
            background-color: #4b5563;
        }
        .outliner-item {
            padding: 6px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-left: 3px solid transparent;
            transition: background-color 0.15s, border-color 0.15s;
        }
        .outliner-item:hover {
            background-color: #4b5563;
        }
        .outliner-item.selected {
            background-color: #1e3a8a;
            border-left-color: #3b82f6;
        }
        .outliner-icon {
            margin-right: 8px;
            color: #9ca3af;
        }
        .inspector-row {
            display: grid;
            grid-template-columns: 1fr 2fr;
            padding: 4px 12px;
            align-items: center;
        }
        .inspector-row label {
            font-size: 0.75rem;
            color: #d1d5db;
        }
        .inspector-row input[type="number"], .inspector-row select, .inspector-row input[type="text"] {
            background-color: #1f2937;
            border: 1px solid #4b5563;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.875rem;
            color: #f3f4f6;
            width: 100%;
            transition: border-color 0.15s;
        }
        .inspector-row input[type="number"]:focus, .inspector-row select:focus {
            border-color: #3b82f6;
            outline: none;
        }
        #timeline-scrubber {
            display: flex;
            align-items: center;
            padding: 0 4px;
        }
        .keyframe-marker {
            position: absolute;
            width: 5px;
            height: 80%;
            background-color: #fcd34d;
            border: 1px solid #b45309;
            border-radius: 2px;
            cursor: pointer;
            top: 10%;
            transition: background-color 0.15s;
        }
        .keyframe-marker:hover {
            background-color: #f59e0b;
        }
        #camera-controls-guide {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.6);
            padding: 8px 12px;
            border-radius: 8px;
            color: #9ca3af;
            font-size: 0.75rem;
            z-index: 10;
        }
        #camera-controls-guide span {
            display: block;
            margin-bottom: 2px;
        }
    </style>
    <!-- Load Three.js and dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/TransformControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/utils/SceneUtils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/OBJLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/libs/fflate.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/exporters/GLTFExporter.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>
<body>
    <!-- Top Bar (Header) -->
    <header class="h-10 bg-gray-800 shadow-md flex items-center justify-between px-4 z-10 relative">
        <div class="flex items-center space-x-4">
            <h1 class="text-xl font-bold text-blue-400">Dough3D</h1>
            <!-- File Menu Dropdown -->
            <div id="file-menu" class="relative">
                <button class="text-sm hover:text-blue-300 transition-colors">File</button>
                <div id="file-menu-dropdown" class="menu-dropdown hidden">
                    <div id="new-scene" class="menu-item">New Scene</div>
                    <div id="save-scene" class="menu-item">Save Scene</div>
                    <div id="load-scene" class="menu-item">Load Scene</div>
                    <div class="h-px bg-gray-600 my-1"></div>
                    <div id="export-gltf" class="menu-item">Export GLTF</div>
                    <div id="import-obj" class="menu-item">Import OBJ</div>
                </div>
            </div>
            <!-- Add Menu Dropdown -->
            <div id="add-menu" class="relative">
                <button class="text-sm hover:text-blue-300 transition-colors">Add</button>
                <div id="add-menu-dropdown" class="menu-dropdown hidden">
                    <div id="add-cube" class="menu-item">Cube</div>
                    <div id="add-sphere" class="menu-item">Sphere</div>
                    <div id="add-plane" class="menu-item">Plane</div>
                    <div class="h-px bg-gray-600 my-1"></div>
                    <div id="add-dir-light" class="menu-item">Directional Light</div>
                    <div id="add-ambient-light" class="menu-item">Ambient Light</div>
                    <div class="h-px bg-gray-600 my-1"></div>
                    <div id="add-spaceship" class="menu-item">Spaceship (Demo)</div>
                    <div id="add-mountain" class="menu-item">Mountain (Demo)</div>
                </div>
            </div>
        </div>
        <!-- Render & Help Actions -->
        <div class="flex items-center space-x-4">
            <div id="render-menu" class="relative">
                <button class="text-sm hover:text-blue-300 transition-colors">Render</button>
                <div id="render-menu-dropdown" class="menu-dropdown right-0 left-auto hidden">
                    <div id="render-image" class="menu-item">Render Image</div>
                    <div id="render-animation" class="menu-item">Render Animation</div>
                </div>
            </div>
            <button id="show-help-modal" class="text-base w-8 h-8 flex items-center justify-center bg-gray-700 hover:bg-gray-600 rounded-full text-white" title="Show Help / Walkthrough">
                <i class="fas fa-question"></i>
            </button>
        </div>
    </header>

    <!-- Main Layout -->
    <div id="main-layout" class="grid" style="grid-template-columns: 250px 1fr 300px; grid-template-rows: 1fr 120px; height: calc(100vh - 40px);">
        <!-- Left Panel: Outliner -->
        <div id="outliner-panel" class="flex flex-col bg-gray-800" style="grid-row: 1 / 3;">
            <div class="panel-header">Outliner</div>
            <div id="outliner-content" class="panel-content space-y-1 text-sm">
                <!-- Scene objects will be listed here -->
            </div>
        </div>

        <!-- Center Panel: Viewport -->
        <div id="viewport-container" class="bg-gray-700 relative" style="grid-row: 1 / 2; grid-column: 2 / 3;">
            <!-- 3D Viewport will be attached here -->
            <!-- Camera Controls Guide -->
            <div id="camera-controls-guide">
                <div class="text-sm font-bold text-blue-400 mb-1">Camera Controls</div>
                <span><kbd class="px-1 bg-gray-700 rounded mr-1">Left Mouse</kbd> - Orbit</span>
                <span><kbd class="px-1 bg-gray-700 rounded mr-1">Right Mouse</kbd> - Pan</span>
                <span><kbd class="px-1 bg-gray-700 rounded mr-1">Mouse Wheel</kbd> - Zoom</span>
            </div>
        </div>

        <!-- Right Panel: Inspector -->
        <div id="inspector-panel" class="flex flex-col bg-gray-800" style="grid-row: 1 / 3;">
            <div class="panel-header">Inspector</div>
            <div id="inspector-content" class="panel-content space-y-3">
                <div class="p-4 text-center text-gray-400 text-sm">Select an object in the Outliner to inspect its properties.</div>
                <!-- Properties will be dynamically inserted here -->
            </div>
        </div>

        <!-- Timeline Panel (New) -->
        <div id="timeline-container" class="p-2" style="grid-row: 2 / 3; grid-column: 2 / 3; background-color: #1a202c; border-top: 1px solid #4a5568;">
            <div class="flex items-center space-x-4 mb-2">
                <h3 class="text-sm font-semibold uppercase text-gray-400">Animation Timeline</h3>
                <div class="flex space-x-2">
                    <button id="anim-play-pause" class="w-8 h-8 flex items-center justify-center bg-blue-600 hover:bg-blue-500 rounded text-white text-base transition-colors" title="Play/Pause"><i class="fas fa-play"></i></button>
                    <button id="anim-stop" class="w-8 h-8 flex items-center justify-center bg-gray-700 hover:bg-gray-600 rounded text-white text-base transition-colors" title="Stop"><i class="fas fa-stop"></i></button>
                    <button id="anim-set-keyframe" class="w-8 h-8 flex items-center justify-center bg-red-600 hover:bg-red-500 rounded text-white text-base transition-colors" title="Set Keyframe (K)"><i class="fas fa-key"></i></button>
                </div>
            </div>
            <div id="timeline-scrubber" class="flex-grow bg-gray-800 rounded relative cursor-pointer h-8 overflow-hidden">
                <div id="scrubber-bar" class="absolute h-full w-0 bg-blue-400 opacity-50"></div>
                <div id="keyframe-markers" class="absolute top-0 w-full h-full pointer-events-none">
                    <!-- Keyframe markers go here -->
                </div>
                <div id="scrubber-handle"></div>
            </div>
            <div class="flex justify-between items-center text-xs mt-1">
                <span id="current-frame-display">Frame: 0 / 100</span>
                <span class="text-yellow-400">Tip: Press <kbd class="px-1 bg-yellow-700 rounded font-bold">K</kbd> to quickly set a keyframe!</span>
            </div>
        </div>
    </div>
    
    <!-- Custom Alert/Notification Container -->
    <div id="notifications" class="fixed top-12 right-4 z-50 space-y-2">
        <!-- Notifications appear here -->
    </div>

    <!-- Help/Walkthrough Modal -->
    <div id="help-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 rounded-xl max-w-2xl w-full p-8 shadow-2xl transform transition-all scale-100">
            <div class="flex justify-between items-center border-b pb-3 mb-4 border-gray-700">
                <h2 class="text-2xl font-bold text-blue-400">Welcome to Dough3D!</h2>
                <button id="close-help-modal" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div class="text-gray-300 space-y-4 text-sm">
                <p>This is a simplified 3D environment designed for easy creation and animation. Here's a quick map of the interface:</p>
                <h3 class="font-semibold text-lg text-white">1. Core Panels:</h3>
                <ul class="list-disc list-inside space-y-2 pl-4">
                    <li><span class="font-bold text-blue-300">Outliner (Left):</span> Lists all objects in your scene (meshes, lights, camera). Click an object to select it.</li>
                    <li><span class="font-bold text-blue-300">Viewport (Center):</span> Your 3D world. Use the mouse to navigate (Orbit/Pan/Zoom, see guide bottom-left). Use the **Gizmo** (Move/Rotate/Scale tool) to manipulate selected objects.</li>
                    <li><span class="font-bold text-blue-300">Inspector (Right):</span> Displays and allows you to edit the exact numeric properties (Position, Material, Name) of the currently selected object.</li>
                </ul>
                <h3 class="font-semibold text-lg text-white border-t pt-3 border-gray-700">2. Animation Made Easy:</h3>
                <p>The <span class="font-bold text-red-300">Timeline (Bottom Center)</span> lets you create "insane things" with animation:</p>
                <ul class="list-disc list-inside space-y-2 pl-4">
                    <li>Move the **Scrubber** (blue line) to the frame where you want a change to occur.</li>
                    <li>Move or rotate your selected object using the **Gizmo**.</li>
                    <li>Press the **<i class="fas fa-key text-red-400"></i> Set Keyframe** button (or press the **K** key!) to record that object's position, rotation, and scale at the current frame.</li>
                    <li>The application will automatically animate (interpolate) the movement between your keyframes!</li>
                </ul>
                <p class="text-center italic mt-6 pt-4 border-t border-gray-700">Start by clicking 'Add' in the top bar!</p>
            </div>
            <div class="flex justify-end mt-6">
                <button id="modal-start-creating" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-lg transition-colors">Start Creating!</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Global variables for THREE.js and state
        let scene, camera, renderer, orbitControls, transformControls;
        let objects = [];
        let selectedObject = null;
        let geometryUUIDMap = new Map();

        // Global Utility for Notifications
        function notify(message, type = 'info', duration = 3000) {
            const container = document.getElementById('notifications');
            const color = type === 'error' ? 'bg-red-600' : type === 'success' ? 'bg-green-600' : 'bg-blue-600';
            const icon = type === 'error' ? 'fas fa-exclamation-circle' : type === 'success' ? 'fas fa-check-circle' : 'fas fa-info-circle';
            const alertDiv = document.createElement('div');
            alertDiv.className = `p-3 rounded-lg shadow-xl text-white flex items-center space-x-2 opacity-0 transition-opacity duration-300 ${color}`;
            alertDiv.innerHTML = `<i class="${icon}"></i> <span>${message}</span>`;
            container.appendChild(alertDiv);
            setTimeout(() => alertDiv.style.opacity = 1, 10);
            setTimeout(() => {
                alertDiv.style.opacity = 0;
                setTimeout(() => container.removeChild(alertDiv), 300);
            }, duration);
        }

        // --- Animation State ---
        let animationData = {};
        let currentFrame = 0;
        const MAX_FRAME = 100;
        const FRAME_RATE = 30;
        let isPlaying = false;
        let lastTime = 0;

        // UI Elements (Animation/Help)
        let playPauseBtn, stopBtn, setKeyframeBtn, scrubberHandle, scrubberBar, keyframeMarkers, currentFrameDisplay;
        let helpModal, showHelpBtn, closeHelpBtn, modalStartBtn;

        // --- Core Functions ---

        function init() {
            // Setup Scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x272727);
            scene.fog = new THREE.Fog(0x272727, 50, 150);
            // Setup Camera
            const viewportContainer = document.getElementById('viewport-container');
            camera = new THREE.PerspectiveCamera(75, viewportContainer.clientWidth / viewportContainer.clientHeight, 0.1, 1000);
            camera.position.set(5, 5, 5);
            camera.name = "Camera";
            objects.push(camera);
            // Setup Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(viewportContainer.clientWidth, viewportContainer.clientHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            viewportContainer.appendChild(renderer.domElement);
            // Setup Controls
            orbitControls = new THREE.OrbitControls(camera, renderer.domElement);
            orbitControls.enableDamping = true;
            orbitControls.dampingFactor = 0.05;
            // Setup Transform Controls (Gizmo)
            transformControls = new THREE.TransformControls(camera, renderer.domElement);
            scene.add(transformControls);
            transformControls.addEventListener('dragging-changed', function (event) {
                orbitControls.enabled = !event.value;
            });
            transformControls.addEventListener('objectChange', function () {
                if (selectedObject) {
                    updateInspector(selectedObject);
                }
            });
            // Set up UI listeners (Crucial fix from last iteration)
            initUIListeners();
            // Initial Geometry and Material Definitions
            setupMaterials();
            addInitialObjects();
            // Handle window resize
            window.addEventListener('resize', onWindowResize, false);
            // Start the animation loop
            animate();
        }

        // Setup initial materials for quick object creation
        const materials = {};
        function setupMaterials() {
            materials.default = new THREE.MeshPhongMaterial({ color: 0xcccccc, shininess: 30 });
            materials.ground = new THREE.MeshPhongMaterial({ color: 0x4a4a4a, side: THREE.DoubleSide });
            materials.lightHelper = new THREE.MeshBasicMaterial({ color: 0xffffee });
            materials.mountainRock = new THREE.MeshLambertMaterial({ color: 0x888888, flatShading: true });
            materials.mountainSnow = new THREE.MeshLambertMaterial({ color: 0xeeeeee, flatShading: true });
            materials.spaceshipBody = new THREE.MeshPhongMaterial({ color: 0x3b82f6, flatShading: true });
            materials.spaceshipFin = new THREE.MeshPhongMaterial({ color: 0xef4444, flatShading: true });
        }

        // Add default scene objects
        function addInitialObjects() {
            // Add Ground
            const groundGeom = new THREE.PlaneGeometry(100, 100);
            const ground = new THREE.Mesh(groundGeom, materials.ground);
            ground.rotation.x = Math.PI / 2;
            ground.position.y = -0.01;
            ground.receiveShadow = true;
            ground.name = "Ground Plane";
            scene.add(ground);
            objects.push(ground);
            // Add Default Light (Directional)
            const dirLight = createDirectionalLight();
            dirLight.name = "Sun Light";
            dirLight.position.set(10, 20, 10);
            scene.add(dirLight);
            objects.push(dirLight);
            // Add Ambient Light
            const ambientLight = createAmbientLight();
            ambientLight.name = "Ambient Light";
            scene.add(ambientLight);
            objects.push(ambientLight);
            // Add a sample cube
            const sampleCube = createCube();
            sampleCube.name = "My First Cube";
            sampleCube.position.set(0, 0.5, 0);
            scene.add(sampleCube);
            objects.push(sampleCube);
            // Select the cube by default
            selectObject(sampleCube);
            updateOutliner();
        }

        // --- Object Creation Factory ---

        function createCube() {
            const geometry = new THREE.BoxGeometry(1, 1, 1);
            const mesh = new THREE.Mesh(geometry, materials.default.clone());
            mesh.castShadow = true;
            mesh.receiveShadow = true;
            mesh.name = "Cube";
            return mesh;
        }

        function createSphere() {
            const geometry = new THREE.SphereGeometry(0.5, 32, 16);
            const mesh = new THREE.Mesh(geometry, materials.default.clone());
            mesh.castShadow = true;
            mesh.receiveShadow = true;
            mesh.name = "Sphere";
            return mesh;
        }

        function createPlane() {
            const geometry = new THREE.PlaneGeometry(5, 5);
            const mesh = new THREE.Mesh(geometry, materials.ground.clone());
            mesh.rotation.x = -Math.PI / 2;
            mesh.castShadow = false;
            mesh.receiveShadow = true;
            mesh.name = "Plane";
            return mesh;
        }

        function createDirectionalLight() {
            const light = new THREE.DirectionalLight(0xffffff, 1.5);
            light.castShadow = true;
            light.shadow.mapSize.width = 1024;
            light.shadow.mapSize.height = 1024;
            light.shadow.camera.near = 0.5;
            light.shadow.camera.far = 50;
            light.shadow.camera.left = -20;
            light.shadow.camera.right = 20;
            light.shadow.camera.top = 20;
            light.shadow.camera.bottom = -20;
            return light;
        }

        function createAmbientLight() {
            const light = new THREE.AmbientLight(0xffffff, 0.5);
            return light;
        }

        function createLowPolySpaceship() {
            const group = new THREE.Group();
            group.name = "Spaceship";
            const bodyGeom = new THREE.ConeGeometry(1, 4, 4);
            const body = new THREE.Mesh(bodyGeom, materials.spaceshipBody);
            body.name = "Body";
            body.rotation.x = Math.PI / 2;
            body.castShadow = true;
            group.add(body);
            // Fins
            const finShape = new THREE.Shape().moveTo(0, 0).lineTo(0, 0.25).lineTo(-2, 0).lineTo(0.5, 0).lineTo(0, 0);
            const finGeomExtrude = new THREE.ExtrudeGeometry(finShape, { depth: 0.1, bevelEnabled: false });
            const fin1 = new THREE.Mesh(finGeomExtrude, materials.spaceshipFin);
            fin1.name = "Fin1";
            fin1.rotation.x = Math.PI / 2;
            fin1.position.z = 1.5;
            fin1.position.y = 0;
            fin1.scale.set(1, 1, 1);
            fin1.castShadow = true;
            group.add(fin1);
            const fin2 = fin1.clone(); fin2.name = "Fin2";
            fin2.rotation.y = Math.PI / 2;
            group.add(fin2);
            const fin3 = fin1.clone(); fin3.name = "Fin3";
            fin3.rotation.y = Math.PI;
            group.add(fin3);
            const fin4 = fin1.clone(); fin4.name = "Fin4";
            fin4.rotation.y = -Math.PI / 2;
            group.add(fin4);
            return group;
        }

        function createLowPolyMountain() {
            const group = new THREE.Group();
            group.name = "Mountain";
            const rockMat = materials.mountainRock.clone();
            const snowMat = materials.mountainSnow.clone();
            // Base
            const baseGeom = new THREE.CylinderGeometry(3, 4, 1, 8);
            const base = new THREE.Mesh(baseGeom, rockMat);
            base.name = "Base";
            base.position.y = 0.5;
            base.castShadow = true;
            group.add(base);
            // Peak
            const peakGeom = new THREE.ConeGeometry(3, 4, 8);
            const peak = new THREE.Mesh(peakGeom, rockMat);
            peak.name = "Peak";
            peak.position.y = 3;
            peak.castShadow = true;
            group.add(peak);
            // Snow Cap
            const snowGeom = new THREE.ConeGeometry(1.5, 2, 8);
            const snow = new THREE.Mesh(snowGeom, snowMat);
            snow.name = "SnowCap";
            snow.position.y = 4.5;
            snow.castShadow = true;
            group.add(snow);
            return group;
        }

        // --- Selection and UI Logic ---

        function updateOutliner() {
            const outliner = document.getElementById('outliner-content');
            outliner.innerHTML = '';
            const getIcon = (obj) => {
                if (obj.isMesh) return '<i class="fas fa-cube outliner-icon"></i>';
                if (obj.isLight) return '<i class="fas fa-lightbulb outliner-icon"></i>';
                if (obj.isGroup) return '<i class="fas fa-layer-group outliner-icon"></i>';
                if (obj.isCamera) return '<i class="fas fa-video outliner-icon"></i>';
                return '<i class="fas fa-map-pin outliner-icon"></i>';
            };
            const filteredChildren = scene.children.filter(obj =>
                obj.name && !obj.name.startsWith('Gizmo') && !(obj instanceof THREE.Camera)
            );
            // Add Camera to the top of the list manually
            if (camera) {
                 const camDiv = document.createElement('div');
                 camDiv.className = `outliner-item text-gray-400 ${selectedObject === camera ? 'selected' : ''}`;
                 camDiv.innerHTML = `${getIcon(camera)} ${camera.name} (Camera)`;
                 camDiv.dataset.uuid = camera.uuid;
                 camDiv.onclick = (e) => selectObject(camera);
                 outliner.appendChild(camDiv);
            }
            filteredChildren.forEach(obj => {
                const div = document.createElement('div');
                div.className = `outliner-item ${selectedObject === obj ? 'selected' : ''}`;
                div.innerHTML = `${getIcon(obj)} ${obj.name}`;
                div.dataset.uuid = obj.uuid;
                // Add delete button
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'text-red-400 hover:text-red-500 text-xs';
                deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    deleteObject(obj);
                };
                div.appendChild(deleteBtn);
                div.onclick = (e) => selectObject(obj);
                outliner.appendChild(div);
            });
        }

        function deleteObject(object) {
            if (object === selectedObject) {
                selectObject(null);
            }
            if (object.isMesh || object.isLight || object.isGroup) {
                scene.remove(object);
                objects = objects.filter(obj => obj !== object);
                delete animationData[object.uuid];
                if (object.isMesh) {
                    object.geometry.dispose();
                    if (Array.isArray(object.material)) {
                        object.material.forEach(m => m.dispose());
                    } else {
                        object.material.dispose();
                    }
                }
                notify(`Deleted: ${object.name}`, 'success');
                updateOutliner();
                updateTimelineUI();
            } else {
                notify("Cannot delete this object type.", 'error');
            }
        }

        function selectObject(object) {
            if (selectedObject) {
                const oldDiv = document.querySelector(`.outliner-item[data-uuid="${selectedObject.uuid}"]`);
                if (oldDiv) oldDiv.classList.remove('selected');
            }
            selectedObject = object;
            if (selectedObject && (selectedObject.isMesh || selectedObject.isLight || selectedObject.isGroup)) {
                const newDiv = document.querySelector(`.outliner-item[data-uuid="${selectedObject.uuid}"]`);
                if (newDiv) newDiv.classList.add('selected');
                transformControls.attach(selectedObject);
                updateInspector(selectedObject);
            } else {
                transformControls.detach();
                updateInspector(null);
            }
            updateTimelineUI();
        }

        function updateInspector(object) {
            const inspector = document.getElementById('inspector-content');
            inspector.innerHTML = '';
            if (!object) {
                inspector.innerHTML = '<div class="p-4 text-center text-gray-400 text-sm">Select an object in the Outliner to inspect its properties.</div>';
                return;
            }
            // --- Name & Type ---
            const nameGroup = document.createElement('div');
            nameGroup.className = 'bg-gray-700 p-2 rounded-lg mx-2 space-y-2';
            nameGroup.innerHTML = `
                <h3 class="text-white font-bold text-lg">${object.name}</h3>
                <div class="text-xs text-gray-400 border-t border-gray-600 pt-1">${object.type} (UUID: ${object.uuid.substring(0, 8)}...)</div>
            `;
            inspector.appendChild(nameGroup);
            // --- Transform Group ---
            const transformGroup = document.createElement('div');
            transformGroup.className = 'bg-gray-700 p-2 rounded-lg mx-2 space-y-1';
            transformGroup.innerHTML = `<h4 class="text-white font-semibold mb-1">Transform</h4>`;
            const createVectorInput = (label, vector, property) => {
                const div = document.createElement('div');
                div.className = 'space-y-1 p-2 bg-gray-600 rounded';
                div.innerHTML = `<label class="block text-xs font-medium text-gray-300 mb-1">${label}</label>`;
                ['x', 'y', 'z'].forEach(axis => {
                    const row = document.createElement('div');
                    row.className = 'inspector-row';
                    const axisLabel = document.createElement('label');
                    axisLabel.textContent = axis.toUpperCase();
                    row.appendChild(axisLabel);
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.step = property === 'rotation' ? 0.01 : 0.1;
                    input.value = property === 'rotation' ? vector[axis] * (180 / Math.PI) : vector[axis];
                    input.dataset.axis = axis;
                    input.onchange = () => {
                        let newValue = parseFloat(input.value);
                        if (isNaN(newValue)) return;
                        if (property === 'rotation') {
                            vector[axis] = newValue * (Math.PI / 180);
                        } else {
                            vector[axis] = newValue;
                        }
                        object.updateMatrixWorld(true);
                        transformControls.updateMatrixWorld();
                        render();
                    };
                    row.appendChild(input);
                    div.appendChild(row);
                });
                transformGroup.appendChild(div);
            };
            createVectorInput('Position (Meters)', object.position, 'position');
            createVectorInput('Rotation (Degrees)', object.rotation, 'rotation');
            createVectorInput('Scale (Factor)', object.scale, 'scale');
            inspector.appendChild(transformGroup);
            // --- Material Group (for meshes only) ---
            if (object.isMesh && object.material && !Array.isArray(object.material)) {
                const materialGroup = document.createElement('div');
                materialGroup.className = 'bg-gray-700 p-2 rounded-lg mx-2 space-y-1';
                materialGroup.innerHTML = `<h4 class="text-white font-semibold mb-1">Material</h4>`;
                const colorRow = document.createElement('div');
                colorRow.className = 'inspector-row';
                colorRow.innerHTML = `<label for="color-picker">Color</label>`;
                const colorInput = document.createElement('input');
                colorInput.type = 'color';
                colorInput.id = 'color-picker';
                const colorToHex = (color) => `#${color.getHexString()}`;
                colorInput.value = colorToHex(object.material.color);
                colorInput.onchange = () => {
                    const newColor = colorInput.value;
                    object.material.color.set(newColor);
                    render();
                };
                colorRow.appendChild(colorInput);
                materialGroup.appendChild(colorRow);
                inspector.appendChild(materialGroup);
            }
        }

        // --- Animation Logic ---

        function findObjectByUUID(uuid) {
            return objects.find(obj => obj.uuid === uuid);
        }

        function updateTimelineUI() {
            currentFrameDisplay.textContent = `Frame: ${Math.round(currentFrame)} / ${MAX_FRAME}`;
            const percent = currentFrame / MAX_FRAME;
            const scrubber = document.getElementById('timeline-scrubber');
            const scrubberWidth = scrubber.clientWidth;
            scrubberHandle.style.left = `${(scrubberWidth * percent) - 1}px`;
            scrubberBar.style.width = `${percent * 100}%`;
            keyframeMarkers.innerHTML = '';
            const targetUUIDs = selectedObject ? [selectedObject.uuid] : Object.keys(animationData);
            targetUUIDs.forEach(uuid => {
                const keyframes = animationData[uuid];
                if (!keyframes) return;
                for (const frame in keyframes) {
                    const marker = document.createElement('div');
                    marker.className = 'keyframe-marker';
                    const markerPercent = (parseInt(frame) / MAX_FRAME) * 100;
                    marker.style.left = `calc(${markerPercent}% - 2.5px)`;
                    const obj = findObjectByUUID(uuid);
                    marker.title = `${obj ? obj.name : 'Object'} - Frame ${frame}`;
                    keyframeMarkers.appendChild(marker);
                }
            });
        }

        let isScrubbing = false;

        function handleScrubStart(e) {
            if (e.button !== 0) return;
            isScrubbing = true;
            if (isPlaying) togglePlayPause();
            handleScrub(e);
            document.addEventListener('mousemove', handleScrub);
            document.addEventListener('mouseup', handleScrubEnd);
        }

        function handleScrub(e) {
            if (!isScrubbing) return;
            const scrubber = document.getElementById('timeline-scrubber');
            const rect = scrubber.getBoundingClientRect();
            let x = e.clientX - rect.left;
            x = Math.max(0, Math.min(x, rect.width));
            const newFrame = Math.round((x / rect.width) * MAX_FRAME);
            goToFrame(newFrame);
        }

        function handleScrubEnd() {
            isScrubbing = false;
            document.removeEventListener('mousemove', handleScrub);
            document.removeEventListener('mouseup', handleScrubEnd);
        }

        function goToFrame(frame) {
            currentFrame = Math.max(0, Math.min(frame, MAX_FRAME));
            updateObjectFromFrame(currentFrame);
            updateTimelineUI();
        }

        function togglePlayPause() {
            isPlaying = !isPlaying;
            if (isPlaying) {
                playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
                lastTime = performance.now();
            } else {
                playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
            }
        }

        function stopAnimation() {
            isPlaying = false;
            playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
            goToFrame(0);
        }

        function recordKeyframe() {
            if (!selectedObject || selectedObject === camera) {
                notify("Select an object (Mesh or Light) to record a keyframe.", 'error');
                return;
            }
            transformControls.detach();
            const uuid = selectedObject.uuid;
            if (!animationData[uuid]) {
                animationData[uuid] = {};
            }
            animationData[uuid][Math.round(currentFrame)] = {
                position: selectedObject.position.clone(),
                rotation: selectedObject.rotation.toVector3(),
                scale: selectedObject.scale.clone(),
            };
            transformControls.attach(selectedObject);
            updateTimelineUI();
            notify(`Keyframe set for ${selectedObject.name} at Frame ${Math.round(currentFrame)}`, 'success');
        }

        function updateObjectFromFrame(frame) {
            const gizmoWasAttached = transformControls.object;
            transformControls.detach();
            for (const uuid in animationData) {
                const keyframes = animationData[uuid];
                const object = findObjectByUUID(uuid);
                if (!object || !keyframes) continue;
                const frames = Object.keys(keyframes).map(Number).sort((a, b) => a - b);
                if (frames.length === 0) continue;
                let k0_frame = frames.filter(f => f <= frame).pop();
                let k1_frame = frames.filter(f => f > frame).shift();
                const k0 = keyframes[k0_frame] || keyframes[frames[0]];
                const k1 = keyframes[k1_frame] || keyframes[frames[frames.length - 1]];
                if (!k0 || !k1) continue;
                let t = 0;
                if (k0_frame !== k1_frame) {
                    t = (frame - k0_frame) / (k1_frame - k0_frame);
                } else if (k0_frame !== undefined) {
                    t = 0;
                }
                // Apply Transform
                object.position.lerpVectors(k0.position, k1.position, t);
                const rot0 = new THREE.Euler().setFromVector3(k0.rotation);
                const rot1 = new THREE.Euler().setFromVector3(k1.rotation);
                object.rotation.x = THREE.MathUtils.lerp(rot0.x, rot1.x, t);
                object.rotation.y = THREE.MathUtils.lerp(rot0.y, rot1.y, t);
                object.rotation.z = THREE.MathUtils.lerp(rot0.z, rot1.z, t);
                object.scale.lerpVectors(k0.scale, k1.scale, t);
                if (object === selectedObject) {
                    updateInspector(object);
                }
            }
            if (gizmoWasAttached) {
                transformControls.attach(gizmoWasAttached);
            }
        }

        // --- Event Handlers & Setup ---

        function onWindowResize() {
            const viewportContainer = document.getElementById('viewport-container');
            camera.aspect = viewportContainer.clientWidth / viewportContainer.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(viewportContainer.clientWidth, viewportContainer.clientHeight);
            updateTimelineUI();
            render();
        }
function initUIListeners() {
            // --- Menu Listeners ---
            document.getElementById('file-menu').addEventListener('click', (e) => {
                document.getElementById('file-menu-dropdown').classList.toggle('hidden');
            });
            document.getElementById('add-menu').addEventListener('click', (e) => {
                document.getElementById('add-menu-dropdown').classList.toggle('hidden');
            });
            document.getElementById('render-menu').addEventListener('click', (e) => {
                document.getElementById('render-menu-dropdown').classList.toggle('hidden');
            });
            document.addEventListener('click', (e) => {
                if (!e.target.closest('#file-menu')) document.getElementById('file-menu-dropdown').classList.add('hidden');
                if (!e.target.closest('#add-menu')) document.getElementById('add-menu-dropdown').classList.add('hidden');
                if (!e.target.closest('#render-menu')) document.getElementById('render-menu-dropdown').classList.add('hidden');
            });
            // --- Object Creation Listeners ---
            document.getElementById('add-cube').addEventListener('click', () => {
                const newObj = createCube();
                newObj.position.set(0, 0.5, 0);
                scene.add(newObj);
                objects.push(newObj);
                selectObject(newObj);
                updateOutliner();
                notify("Cube added to scene.", 'success');
            });
            document.getElementById('add-sphere').addEventListener('click', () => {
                const newObj = createSphere();
                newObj.position.set(0, 0.5, 0);
                scene.add(newObj);
                objects.push(newObj);
                selectObject(newObj);
                updateOutliner();
                notify("Sphere added to scene.", 'success');
            });
            document.getElementById('add-plane').addEventListener('click', () => {
                const newObj = createPlane();
                newObj.position.set(0, 0, 0);
                scene.add(newObj);
                objects.push(newObj);
                selectObject(newObj);
                updateOutliner();
                notify("Plane added to scene.", 'success');
            });
            document.getElementById('add-dir-light').addEventListener('click', () => {
                const newObj = createDirectionalLight();
                newObj.position.set(5, 10, 5);
                scene.add(newObj);
                objects.push(newObj);
                selectObject(newObj);
                updateOutliner();
                notify("Directional Light added.", 'success');
            });
            document.getElementById('add-ambient-light').addEventListener('click', () => {
                const newObj = createAmbientLight();
                scene.add(newObj);
                objects.push(newObj);
                selectObject(newObj);
                updateOutliner();
                notify("Ambient Light added.", 'success');
            });
            document.getElementById('add-spaceship').addEventListener('click', () => {
                const newObj = createLowPolySpaceship();
                newObj.position.set(0, 5, -5);
                scene.add(newObj);
                objects.push(newObj);
                selectObject(newObj);
                updateOutliner();
                notify("Demo Spaceship added.", 'success');
            });
             document.getElementById('add-mountain').addEventListener('click', () => {
                const newObj = createLowPolyMountain();
                newObj.position.set(5, 0, 5);
                scene.add(newObj);
                objects.push(newObj);
                selectObject(newObj);
                updateOutliner();
                notify("Demo Mountain added.", 'success');
            });
            // --- Animation UI Listeners ---
            playPauseBtn = document.getElementById('anim-play-pause');
            stopBtn = document.getElementById('anim-stop');
            setKeyframeBtn = document.getElementById('anim-set-keyframe');
            scrubberHandle = document.getElementById('scrubber-handle');
            scrubberBar = document.getElementById('scrubber-bar');
            keyframeMarkers = document.getElementById('keyframe-markers');
            currentFrameDisplay = document.getElementById('current-frame-display');
            playPauseBtn.addEventListener('click', togglePlayPause);
            stopBtn.addEventListener('click', stopAnimation);
            setKeyframeBtn.addEventListener('click', recordKeyframe);
            document.getElementById('timeline-scrubber').addEventListener('mousedown', handleScrubStart);
            // --- Help Modal Listeners ---
            helpModal = document.getElementById('help-modal');
            showHelpBtn = document.getElementById('show-help-modal');
            closeHelpBtn = document.getElementById('close-help-modal');
            modalStartBtn = document.getElementById('modal-start-creating');
            showHelpBtn.addEventListener('click', () => helpModal.classList.remove('hidden'));
            closeHelpBtn.addEventListener('click', () => helpModal.classList.add('hidden'));
            modalStartBtn.addEventListener('click', () => helpModal.classList.add('hidden'));
            if (typeof localStorage !== 'undefined' && !localStorage.getItem('dough3d_help_seen')) {
                helpModal.classList.remove('hidden');
                localStorage.setItem('dough3d_help_seen', 'true');
            }
            // --- Global Keyboard Shortcuts ---
            document.addEventListener('keydown', (e) => {
                if (e.key.toLowerCase() === 'k') {
                    e.preventDefault();
                    recordKeyframe();
                }
                if (e.key === ' ' && !e.target.matches('input, textarea')) {
                    e.preventDefault();
                    togglePlayPause();
                }
            });
        }

        // --- Render Loop ---

        function render() {
            renderer.render(scene, camera);
        }

        // Modified animate function for frame rate control and playback
        function animate(time) {
            requestAnimationFrame(animate);
            if (isPlaying) {
                if (!lastTime) lastTime = time;
                const delta = (time - lastTime) / 1000;
                const framesToAdvance = delta * FRAME_RATE;
                if (framesToAdvance >= 1 || delta > (1 / FRAME_RATE)) {
                    let nextFrame = currentFrame + framesToAdvance;
                    if (nextFrame > MAX_FRAME) {
                        nextFrame = nextFrame % (MAX_FRAME + 1);
                    }
                    goToFrame(nextFrame);
                    lastTime = time;
                }
            }
            orbitControls.update();
            render();
        }

        // Wait for the window to fully load before initializing THREE.js
        window.onload = function () {
            init();
        }
    </script>
</body>
</html>
